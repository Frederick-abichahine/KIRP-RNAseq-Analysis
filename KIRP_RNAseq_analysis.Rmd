---
title: "Kidney Renal Papillary Cell Carcinoma"
subtitle: "Bioinformatics Resources Project"
author: 
  - "Frederick Abi Chahine"
  - "Hala Alshaar"
  - "Anastasia Bertova"
date: "`r format(Sys.Date(), '%B %d, %Y')`"
output:
  html_document:
    toc: true
    toc_depth: 3
    toc_float:
      collapsed: false
      smooth_scroll: true
    code_folding: show
    fig_caption: true
    df_print: paged
    theme: flatly
    highlight: zenburn
    self_contained: true
params:
  show_code: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
  
## Introduction  
  
**Kidney Renal Papillary Cell Carcinoma** (KIRP) is a distinct subtype of renal cell carcinoma that represents approximately *10–15%* of all kidney cancers. It is characterized by unique histological features and molecular alterations that differ from the more common clear cell renal carcinoma. KIRP is further classified into two main subtypes, **type 1 and type 2**, which vary in their cellular characteristics and clinical behavior (Delahunt & Eble, 1997). Despite advances in understanding some genetic mutations involved in KIRP, such as alterations in the *MET gene and fumarate hydratase (FH)*, much remains unknown about the full spectrum of molecular changes driving this disease (TCGA Research Network, 2016; Menko et al., 2014).

**RNA sequencing** (RNA-seq) is a powerful technology that enables the comprehensive analysis of gene expression across the entire transcriptome. By examining RNA-Seq data from *50 tumor samples and 50 matched normal kidney tissue controls*, we can identify **differentially expressed genes (DEGs) and disrupted molecular pathways specific to KIRP**. This analysis will deepen our understanding of the biological mechanisms underlying tumor initiation and progression. Additionally, it may reveal **novel biomarkers** for diagnosis and **potential therapeutic targets**, ultimately contributing to improved clinical management of KIRP patients (Choueiri et al., 2015; Truong & Shen, 2011).
  
## Project Pipeline  
  
This project focuses on the analysis of **RNA-seq** count data derived from KIRP samples obtained from **The Cancer Genome Atlas** (TCGA). The goal is to explore the molecular differences between **tumor and normal tissues** through a comprehensive bioinformatics pipeline. Key steps include **data preprocessing, filtering for protein-coding genes** using the *biomaRt package*, and **identifying DEGs** via the *edgeR package*. **Visualization** techniques such as *volcano plots and heatmaps* are used to interpret the differential expression results. **Gene set enrichment analysis** (GSEA) is performed using the *fgsea package* to uncover significantly altered pathways in cancer. In addition, we **investigate transcription factors** (TFs) with enriched binding motifs in the promoters of regulated genes and **examine protein-protein interaction** (PPI) networks using *STRING and igraph*. This multi-layered approach provides insights into the transcriptional landscape of KIRP and highlights potential biomarkers or therapeutic targets for further research.

## Loading Dependencies  
  
```{r libraries, message=FALSE, warning=FALSE}
library(biomaRt) # For querying Ensembl databases to retrieve gene information
library(edgeR) # For differential expression analysis of RNA-seq data
library(ggplot2) # For data visualization
library(ComplexHeatmap) # For creating customizable heatmaps
library(circlize) # For being able to use color functions in ComplexHeatmap
library(RColorBrewer) # For color palettes
library(fgsea) # For performing gene set enrichment analysis
library(msigdbr) # For loading MSigDB gene sets
library(MotifDb) # For working with transcription factor binding motifs
library(PWMEnrich) # For motif enrichment analysis
library(PWMEnrich.Hsapiens.background) # For human background motif data
library(Biostrings) # For handling biological sequences
library(GenomicRanges) # For working with genomic ranges and annotations
library(TxDb.Hsapiens.UCSC.hg38.knownGene) # For gene annotations and genomic features (hg38)
library(TxDb.Hsapiens.UCSC.hg19.knownGene) # For gene annotations and genomic features (hg19)
library(BSgenome.Hsapiens.UCSC.hg38) # For accessing the human genome sequence (hg38)
library(dplyr) # For data manipulation and transformation
library(STRINGdb) # For accessing the STRING database for protein-protein interactions
library(igraph) # For creating and analyzing networks
library(ggraph) # For visualizing networks with ggplot2 syntax
library(tidygraph) # For tidy data manipulation of graph objects
```


## 1. Loading, Exploring & Preprocessing the Data  

```{r}
# Setting dynamic working directory
setwd(dirname(rstudioapi::getActiveDocumentContext()$path))

# Reading the KIRP data
load("./BR_project_data_kidney_renal_papillary_cell_carcinoma.RData")

# Exploring the data
ls()
head(raw_counts_df[, 1:5])
head(c_anno_df)
head(r_anno_df)
summary(raw_counts_df)
summary(c_anno_df)
summary(r_anno_df)
dim(raw_counts_df)
dim(c_anno_df)
dim(r_anno_df)

# Preprocessing required fields
c_anno_df$condition <- factor(c_anno_df$condition)
summary(c_anno_df$condition)
```
  
The RData file contains **three data frames**:  
  
| Data Frame       | Description                                      | Dimensions     |  
|------------------|--------------------------------------------------|----------------|  
| `raw_counts_df`  | Raw RNA-seq counts                               | 62940 x 100    |  
| `c_anno_df`      | Sample names and conditions                      | 100 x 2        |  
| `r_anno_df`      | Ensembl gene IDs, gene lengths, and gene symbols | 62940 x 3      |  
  
Additionally, the condition column in `c_anno_df` was converted to a factor to facilitate downstream analysis.
  
## 2. Extracting Protein-Coding Genes  

```{r}
# Querying the Ensembl database for homo sapiens gene information
ensembl <- useEnsembl(biomart = "genes", dataset = "hsapiens_gene_ensembl")

# Getting gene information for the Ensembl IDs in r_anno_df
gene_info <- getBM(attributes = c("ensembl_gene_id", "gene_biotype"),
                   filters = "ensembl_gene_id",
                   values = r_anno_df$ensembl_gene_id,
                   mart = ensembl)

# Extracting protein-coding genes from the gene_info data frame
protein_coding_genes <- gene_info[gene_info$gene_biotype == "protein_coding", ]
cat("> Number of protein-coding genes:", nrow(protein_coding_genes), "\n")

# Updating data frames to include only protein-coding genes
raw_counts_df <- raw_counts_df[rownames(raw_counts_df) %in% protein_coding_genes$ensembl_gene_id, ]
r_anno_df <- r_anno_df[r_anno_df$ensembl_gene_id %in% protein_coding_genes$ensembl_gene_id, ]
```
  
From the annotated gene list, we **filtered for protein-coding genes** using the *Ensembl BioMart database*. This resulted in a subset of *22152 protein-coding genes* out of the original *62940 input genes*. The raw count matrix and annotation were aligned accordingly to ensure consistency for downstream expression analysis.  
  
The updated dimensions of the data frames are as follows:  

| Data Frame       | Dimensions Before | Dimensions After  |
|------------------|-------------------|-------------------|
| `raw_counts_df`  | 62940 x 100       | 22152 x 100       |
| `r_anno_df`      | 62940 x 3         | 22152 x 3         |  
  
## 3. Differential Expression Analysis  
  
### 3.1. Setup & Filtering  
  
```{r}
group <- c_anno_df$condition

# Creating DGEList object
dge <- DGEList(counts = raw_counts_df, group = group)

# Filtering genes
# Condition: keep if count > 20 in at least 5 samples of either group
keep <- rowSums(dge$counts[, group == "case"] > 20) >= 5 |
        rowSums(dge$counts[, group == "control"] > 20) >= 5
dge <- dge[keep, , keep.lib.sizes = FALSE]
```
  
### 3.2. Normalization & Model Fitting  

```{r}
# Normalizing and constructing the design matrix
dge <- calcNormFactors(dge)
design <- model.matrix(~ group)

# Estimating dispersion and fitting the model
dge <- estimateDisp(dge, design)
fit <- glmFit(dge, design)
lrt <- glmLRT(fit, coef = 2)
```
  
### 3.3. Annotating DEGs  
  
```{r}
# Extracting results
results <- topTags(lrt, n = Inf)$table

# Adding average log CPM using edgeR model-based estimate
results$logCPM <- aveLogCPM(dge)

# Classifying DEGs
results$DEG <- "not_significant"
results$DEG[results$FDR < 0.05 & results$logFC > 1.5 & results$logCPM > 1] <- "up"
results$DEG[results$FDR < 0.05 & results$logFC < -1.5 & results$logCPM > 1] <- "down"

# Displaying summary
table(results$DEG)

# combine the up and down 
```
  
After applying **differential expression analysis** using the *edgeR package*, a total of *2521 genes* were identified as significantly altered between the case and control groups. Among these, *955 genes* showed significant **up-regulation**, and *1566 genes* were significantly **down-regulated**, based on the thresholds of *FDR < 0.05, log2 fold change > 1.5 (or < -1.5), and logCPM > 1*.

The majority of analyzed genes (14543 genes) did not show statistically significant expression changes under these criteria. These results indicate a focused subset of genes potentially involved in the biological differences between the two conditions.

| Regulation       | Count    | Condition                                    |
|------------------|----------|----------------------------------------------|
| Up               | 955      | if FDR < 0.05, log2FC > 1.5, and logCPM > 1  |
| Down             | 1566     | if FDR < 0.05, log2FC < -1.5, and logCPM > 1 |
| Not Significant  | 14543    | if FDR >= 0.05 or logCPM <= 1                |
| **Total**        | **17064**|                                              |
  
### 3.4. Results Visualization  
  
#### 3.4.1. Volcano Plot  

```{r}
# Plotting the volcano plot
ggplot(results, aes(x = logFC, y = -log10(FDR), color = DEG)) +
  geom_point(alpha = 0.6, size = 1.2) +
  scale_color_manual(
    values = c("up" = "#D62728", "down" = "#1F77B4", "not_significant" = "grey80")
  ) +
  theme_minimal(base_size = 14) +
  labs(
    title = "Volcano Plot of Differential Expression",
    
    x = expression("Log"[2]*" Fold Change"),
    y = expression("-Log"[10]*" FDR"),
    color = "Regulation"
  ) +
  geom_vline(xintercept = c(-1.5, 1.5), linetype = "dashed", color = "black", alpha = 0.5) +
  geom_hline(yintercept = -log10(0.05), linetype = "dashed", color = "black", alpha = 0.5) +
  theme(
    plot.title = element_text(hjust = 0.5),
    legend.position = "top",
    panel.grid.minor = element_blank()
)
```
  
This `volcano plot` visualizes the **differential gene expression between tumor (case) and normal (control) samples** in KIRP. Each point represents a gene, plotted by its log2 fold change (x-axis) and statistical significance as −log10 FDR (y-axis). Genes that are significantly **up-regulated** (lo2FC > 1.5, FDR < 0.05, and logCPM > 1) are shown in **red**, while significantly **down-regulated** genes (log2FC < −1.5) are in **blue**. **Non-significant** genes are shown in **grey**. The dashed vertical and horizontal lines indicate the fold-change and FDR thresholds used. The plot highlights a substantial number of both up- and down-regulated genes, reflecting **widespread transcriptional alterations in the tumor samples**, with several genes showing both strong expression changes and high statistical significance. Notably, the plot reveals a slight **asymmetry**, with more down-regulated genes than up-regulated ones.
  
#### 3.4.2. Heatmap Focused on Up & Down Regulated Genes  
  
```{r}
# Generating the expression matrix for heatmap
logCPM_mat <- cpm(dge, log = TRUE)
deg_genes <- rownames(results)[results$DEG %in% c("up", "down")]
heat_data <- logCPM_mat[deg_genes, ]
heat_data_scaled <- t(scale(t(heat_data)))

# Generating the annotation data frame
condition <- c_anno_df$condition
names(condition) <- colnames(heat_data_scaled)

# Definining heatmap annotation and colors
ha <- HeatmapAnnotation(
  Condition = condition,
  col = list(Condition = c("case" = "#02BA0F", "control" = "#3DED97")),
  annotation_legend_param = list(title = "Condition")
)
col_fun <- colorRamp2(c(-8, 0, 8), c("#053061", "#f7f7f7", "#67001f"))

# Plotting the heatmap
ht_opt$message = FALSE # Just to supress messages from ComplexHeatmap library
Heatmap(
  matrix = heat_data_scaled,
  name = "Z-score logCPM",
  top_annotation = ha,
  col = col_fun,
  show_row_names = FALSE,
  show_column_names = FALSE,
  cluster_rows = TRUE,
  cluster_columns = TRUE,
  column_title = "Differentially Expressed Genes (Z-score logCPM)",
  heatmap_legend_param = list(
    title = "Z-score logCPM"
  )
)
```
    
This `heatmap` shows the **expression profiles of DEGs across tumor (case) and normal (control) samples**, using Z-score normalized logCPM values. Samples cluster clearly by condition, reflecting distinct gene expression patterns between groups. **Red and blue** blocks indicate genes consistently **up- or down-regulated** within each condition. Z-score normalization emphasizes relative expression changes, facilitating comparison across genes with different baseline levels. The observed clustering of both samples and genes highlights **strong transcriptional differences** and supports the reliability of the differential expression analysis.  
  